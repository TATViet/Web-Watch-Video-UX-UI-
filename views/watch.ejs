<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OwlLoop ‚Äî Watch</title>

<style>
:root{
  --mobile-w:420px;
  --bg:#1f3326;
  --card:#2a4031;
  --muted:#b7c7bc;
  --accent:#88c273;
  --accent-2:#a6d39b;
  --radius:14px;
  font-family: Inter, system-ui, Arial;
}

*{box-sizing:border-box}

body{
  margin:0;
  background:#111;
  color:#fff;
  display:flex;
  justify-content:center;
}

.container{
  width:100%;
  max-width:var(--mobile-w);
  min-height:100vh;
  padding:14px;
  background:var(--bg);
}

/* ===== ICON SYSTEM ===== */
.icon{
  width:24px;
  height:24px;
  stroke:#fff;
  stroke-width:2;
  fill:none;
}

.icon-btn{
  height:44px;
  padding:0 14px;
  border-radius:12px;
  background:rgba(255,255,255,.08);
  display:flex;
  align-items:center;
  gap:8px;
  font-size:14px;
  cursor:pointer;
}

/* ===== HEADER ===== */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:16px;
}

/* LOGO: full green */
.logo{
  width:44px;
  height:44px;
  border-radius:14px;
  background:linear-gradient(135deg,var(--accent),var(--accent-2));
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
}

/* ===== PLAYING ===== */
.playing{
  background:var(--card);
  border-radius:var(--radius);
  padding:14px;
}

.playing-top{
  display:flex;
  justify-content:space-between;
  gap:10px;
}

.playing h3{
  margin:6px 0 4px;
  font-size:16px;
}

.channel{
  font-size:13px;
  color:var(--muted);
}

.auto{
  background:rgba(255,255,255,.08);
  padding:8px;
  border-radius:8px;
  font-size:13px;
  text-align:center;
  cursor:pointer;
}

.auto.on {
  background: var(--accent);
  color: #123;
}

/* ===== VIDEO ===== */
.video-wrap{
  margin-top:12px;
  background:#000;
  border-radius:12px;
  overflow:hidden;
}

.ad{
  background:#777;
  text-align:center;
  padding:14px;
  font-weight:700;
}

.video{
  position:relative;
  aspect-ratio:16/9;
}

.video iframe{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  border:0;
}

/* ===== CONTROLS ===== */
.controls{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:10px;
}

.control-group{
  display:flex;
  gap:16px;
}

/* ===== TAG ===== */
.tags{
  margin-top:8px;
  font-size:13px;
}

.tags .tag{
  padding:8px 12px;
  border-radius:999px;
  background:rgba(255,255,255,.08);
  font-size:13px;
  cursor:pointer;
  display:inline-block;
}

/* ===== LIST ===== */
.list{
  margin-top:18px;
  background:var(--card);
  border-radius:var(--radius);
  padding:14px;
}

.item{
  display:flex;
  gap:12px;
  margin-bottom:12px;
  cursor:pointer;
  align-items: flex-start; /* Align top ƒë·ªÉ text d√†i kh√¥ng ·∫£nh h∆∞·ªüng thumbnail */
}

.thumb{
  width:80px;
  height:50px;
  border-radius:8px;
  overflow:hidden;
  position:relative;
  flex-shrink: 0; /* NgƒÉn thumbnail b·ªã co l·∫°i */
}

.thumb img{
  width:100%;
  height:100%;
  object-fit:cover;
}

.item-info {
  flex: 1; /* Chi·∫øm h·∫øt kh√¥ng gian c√≤n l·∫°i */
  min-width: 0; /* Cho ph√©p co l·∫°i n·∫øu c·∫ßn */
}

.item-title{
  font-size:14px;
  font-weight:600;
  overflow: hidden; /* ·∫®n text tr√†n */
  text-overflow: ellipsis; /* Th√™m d·∫•u ... n·∫øu d√†i */
  display: -webkit-box;
  -webkit-line-clamp: 2; /* Gi·ªõi h·∫°n 2 d√≤ng */
  -webkit-box-orient: vertical;
  line-height: 1.2; /* ƒêi·ªÅu ch·ªânh line height */
}

.item-meta{
  font-size:12px;
  color:var(--muted);
  white-space: nowrap; /* Kh√¥ng wrap meta */
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ===== PREMIUM ===== */
.premium{
  margin-top:14px;
  border-top:1px solid rgba(255,255,255,.2);
  padding-top:10px;
  font-size:13px;
}

/* =======================
   FOCUS MODE (NEW)
======================= */

/* Overlay m·ªù to√†n trang */
#focusOverlay {
  position: fixed;
  inset: 0;
  z-index: 40;

  background: rgba(0, 0, 0, 0.25);
  backdrop-filter: blur(2px);

  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
}

/* Video LU√îN n·ªïi tr√™n overlay */
.video-wrap,
.video-wrapper {
  position: relative;
  z-index: 60;
}

/* N√∫t ƒë√≥ng ‚ùå */
#focusClose {
  position: fixed;
  top: 10px;
  right: 12px;
  z-index: 70;

  width: 26px;
  height: 26px;
  border-radius: 50%;

  background: rgba(0,0,0,0.6);
  color: #fff;

  display: flex;
  align-items: center;
  justify-content: center;

  font-size: 14px;
  cursor: pointer;

  opacity: 0;
  pointer-events: none;
}

/* Khi b·∫≠t focus */
body.focus-mode #focusOverlay {
  opacity: 1;
  pointer-events: auto;
}

body.focus-mode #focusClose {
  opacity: 1;
  pointer-events: auto;
}

/* Shield active */
body.focus-mode #focusToggle {
  color: #2ecc71;
}

/* ===== TUTORIAL NOTIFICATION ===== */
.tutorial-notif {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--card);
  padding: 12px 16px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  z-index: 50;
  max-width: 200px;
  font-size: 13px;
}

.tutorial-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.tutorial-close {
  cursor: pointer;
  opacity: 0.7;
}

/* ===== COMMENT MODAL ===== */
.modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:100;
}

.modal-overlay.show{
  display:flex;
}

.modal{
  width:90%;
  max-width:360px;
  background:var(--card);
  border-radius:16px;
  padding:14px;
}

.modal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

.close{
  cursor:pointer;
  opacity:.7;
}

#commentList {
  max-height: 200px;
  overflow-y: auto;
  margin-bottom: 10px;
}

#commentList div {
  padding: 8px;
  border-bottom: 1px solid rgba(255,255,255,.08);
  font-size: 13px;
}

#commentInput {
  width: 100%;
  height: 60px;
  padding: 10px;
  border-radius: 10px;
  border: none;
  background: #1f3326;
  color: #fff;
  margin-bottom: 10px;
  resize: none;
}

#submitComment {
  padding: 8px 16px;
  border-radius: 10px;
  border: none;
  background: var(--accent);
  color: #123;
  font-weight: 600;
  cursor: pointer;
}

</style>
</head>
<body>

<div class="container">

<header>
  <div class="logo" onclick="location.href='/'" style="cursor:pointer;">ü¶â</div>

  <div style="display:flex; gap:8px;">
    <% if (!user) { %>
      <div class="icon-btn" onclick="location.href='/login'">
        <svg class="icon" viewBox="0 0 24 24">
          <circle cx="12" cy="8" r="4"/>
          <path d="M4 20c0-4 4-6 8-6s8 2 8 6"/>
        </svg>
        Login
      </div>
    <% } else { %>
      <div class="icon-btn" onclick="location.href='/account'">
        <svg class="icon" viewBox="0 0 24 24">
          <circle cx="12" cy="8" r="4"/>
          <path d="M4 20c0-4 4-6 8-6s8 2 8 6"/>
        </svg>
        <%= user.name %>
      </div>
    <% } %>

    <div class="icon-btn">
      <svg class="icon" viewBox="0 0 24 24">
        <path d="M4 4h16v16H4z"/>
        <path d="M4 6l8 6 8-6"/>
      </svg>
    </div>

    <div class="icon-btn">
      <svg class="icon" viewBox="0 0 24 24">
        <circle cx="11" cy="11" r="7"/>
        <line x1="21" y1="21" x2="16.5" y2="16.5"/>
      </svg>
    </div>
  </div>
</header>

<% if (video) { %>
  <% 
    // Extract VIDEO_ID t·ª´ URL for playing video
    let playingId = '';
    if (video.url.includes('youtube.com/watch?v=')) {
      playingId = video.url.split('v=')[1].split('&')[0];
    } else if (video.url.includes('youtu.be/')) {
      playingId = video.url.split('youtu.be/')[1].split('?')[0];
    }
  %>
  <section class="playing">
    <div class="playing-top">
      <div>
        <div style="font-size:13px;color:#ccc">Playing</div>
        <h3><%= video.title %></h3>
        <div class="channel">Channel: <%= video.channel || 'Unknown' %></div>
      </div>
      <div class="auto" onclick="toggleAuto(this)">Auto Switch<br><b>OFF</b></div>
    </div>

    <div class="video-wrap">
      <div class="ad">AD</div>

      <div class="video-wrapper">
        <div class="video">
          <iframe
            id="playerIframe"
            src="https://www.youtube-nocookie.com/embed/<%= playingId %>?enablejsapi=1"
            allowfullscreen>
          </iframe>
        </div>
      </div>

      <div class="ad">AD</div>
    </div>

    <div class="controls">
      <div class="control-group">
        <% if (prevId) { %>
          <a href="/watch/<%= prevId %>" class="icon-btn">
            <svg class="icon" viewBox="0 0 24 24">
              <polygon points="15,5 5,12 15,19"/>
            </svg>
          </a>
        <% } else { %>
          <div class="icon-btn" style="opacity:0.5; pointer-events:none;">
            <svg class="icon" viewBox="0 0 24 24">
              <polygon points="15,5 5,12 15,19"/>
            </svg>
          </div>
        <% } %>

        <% if (nextId) { %>
          <a href="/watch/<%= nextId %>" class="icon-btn">
            <svg class="icon" viewBox="0 0 24 24">
              <polygon points="9,5 19,12 9,19"/>
            </svg>
          </a>
        <% } else { %>
          <div class="icon-btn" style="opacity:0.5; pointer-events:none;">
            <svg class="icon" viewBox="0 0 24 24">
              <polygon points="9,5 19,12 9,19"/>
            </svg>
          </div>
        <% } %>

        <!-- üõ°Ô∏è FOCUS BUTTON -->
        <div class="icon-btn" id="focusToggle" title="Focus mode">üõ°Ô∏è</div>

        <!-- üí¨ COMMENT BUTTON -->
        <div class="icon-btn" id="commentToggle" title="Comments">üí¨</div>
      </div>

      
    </div>

    <div class="tags">
      Tag: <% if (video.topics && video.topics.length > 0) { %>
        <% video.topics.forEach(topic => { %>
          <b class="tag" onclick="location.href='/topic/<%= topic.toLowerCase() %>'"><%= topic %></b>
        <% }); %>
      <% } else { %>
        <b class="tag">Unknown</b>
      <% } %>
    </div>
  </section>
<% } else { %>
  <p>Video not found.</p>
<% } %>

<section class="list">
  <h4>List of video</h4>

  <% if (videos && videos.length > 0) { %>
    <% videos.forEach(video => { %>
      <% 
        // Extract VIDEO_ID t·ª´ URL
        let videoId = '';
        if (video.url.includes('youtube.com/watch?v=')) {
          videoId = video.url.split('v=')[1].split('&')[0]; // L·∫•y ID t·ª´ full URL
        } else if (video.url.includes('youtu.be/')) {
          videoId = video.url.split('youtu.be/')[1].split('?')[0]; // L·∫•y ID t·ª´ short URL
        }
        const thumbnailUrl = videoId ? `https://img.youtube.com/vi/${videoId}/hqdefault.jpg` : 'https://via.placeholder.com/80x50?text=No+Thumb'; // Placeholder n·∫øu kh√¥ng c√≥
      %>
      <div class="item" onclick="location.href='/watch/<%= video.id %>'">
        <div class="thumb">
          <img src="<%= thumbnailUrl %>" alt="<%= video.title %>">
        </div>
        <div class="item-info">
          <div class="item-title"><%= video.title %></div>
          <div class="item-meta"><%= video.duration %> ‚Ä¢ <%= video.channel || 'Unknown' %></div>
        </div>
      </div>
    <% }); %>
  <% } else { %>
    <p>No more videos available.</p>
  <% } %>

  <div class="premium">
    <b>Premium features</b>
    <ul>
      <li>No Ad</li>
      <li>Background play</li>
      <li>Detail Topic and Block, Favorite channel</li>
    </ul>
  </div>
</section>

</div>

<!-- OVERLAY CH·∫∂N CLICK (TR√äN C·∫¢ VIDEO) -->
<div id="focusOverlay"></div>

<!-- N√öT ƒê√ìNG (LU√îN CLICK ƒê∆Ø·ª¢C) -->
<div
  id="focusClose"
  style="
    position: fixed;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    pointer-events: auto;
  "
>
  ‚úï
</div>

<!-- COMMENT MODAL -->
<div class="modal-overlay" id="commentModal">
  <div class="modal">
    <div class="modal-header">
      <strong>Comments</strong>
      <span class="close" id="commentClose">‚úï</span>
    </div>
    <div id="commentList"></div>
    <textarea id="commentInput" placeholder="Write a comment..."></textarea>
    <button id="submitComment">Submit</button>
  </div>
</div>

<script>
const nextId = <%= nextId ? nextId : 'null' %>;
const videoId = <%= video ? video.id : 'null' %>;

// Load YouTube API
var tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

var player;
function onYouTubeIframeAPIReady() {
  player = new YT.Player('playerIframe', {
    events: {
      'onStateChange': onPlayerStateChange
    }
  });
}

function onPlayerStateChange(event) {
  if (event.data == YT.PlayerState.ENDED) {
    if (localStorage.getItem('autoSwitch') === 'ON' && nextId) {
      location.href = '/watch/' + nextId;
    }
  }
}

  const focusBtn   = document.getElementById("focusToggle");
  const focusClose = document.getElementById("focusClose");
  const iframe     = document.getElementById("playerIframe");

  focusBtn.addEventListener("click", () => {
    document.body.classList.add("focus-mode");

    // üîí CH·∫∂N CLICK VIDEO (QUAN TR·ªåNG)
    iframe.style.pointerEvents = "none";

    if (localStorage.getItem('tutorialStep') === '1') {
      completeTutorial();
    }
  });

  focusClose.addEventListener("click", () => {
    document.body.classList.remove("focus-mode");

    // üîì M·ªû L·∫†I CLICK VIDEO
    iframe.style.pointerEvents = "auto";
  });

  function toggleAuto(el) {
    const stateEl = el.querySelector('b');
    const currentState = stateEl.textContent;
    const newState = currentState === 'OFF' ? 'ON' : 'OFF';
    stateEl.textContent = newState;
    localStorage.setItem('autoSwitch', newState);
    el.classList.toggle('on', newState === 'ON');
  }

  // Kh√¥i ph·ª•c state t·ª´ localStorage khi load page
  window.addEventListener('load', () => {
    const autoEl = document.querySelector('.auto');
    const savedState = localStorage.getItem('autoSwitch') || 'OFF';
    autoEl.querySelector('b').textContent = savedState;
    if (savedState === 'ON') {
      autoEl.classList.add('on');
    }

    <% if (user && !user.tutorial_completed && user.created_at) { %>
    if (localStorage.getItem('tutorialStep') === '1') {
      showTutorial2();
    }
    <% } %>
  });

<% if (user && !user.tutorial_completed && user.created_at) { %>
function showTutorial2() {
  const notif = document.createElement('div');
  notif.classList.add('tutorial-notif');
  notif.id = 'tutorialNotif2';
  notif.innerHTML = `
    <div class="tutorial-header">
      <strong>Protect Mode</strong>
      <span class="tutorial-close" onclick="cancelTutorial()">‚úï</span>
    </div>
    <p>Now click the üõ°Ô∏è button to enable protect mode. It helps you focus by blurring the background and preventing distractions.</p>
  `;
  document.body.appendChild(notif);
}

function cancelTutorial() {
  if (confirm("Are you sure you want to cancel the tutorial?")) {
    fetch('/complete-tutorial', { method: 'POST' })
      .then(() => {
        const notif = document.getElementById('tutorialNotif2');
        if (notif) notif.remove();
        localStorage.removeItem('tutorialStep');
      })
      .catch(err => console.error(err));
  }
}

function completeTutorial() {
  fetch('/complete-tutorial', { method: 'POST' })
    .then(() => {
      const completeNotif = document.createElement('div');
      completeNotif.classList.add('tutorial-notif');
      completeNotif.innerHTML = `
        <div class="tutorial-header">
          <strong>Tutorial Complete!</strong>
          <span class="tutorial-close" onclick="this.parentNode.parentNode.remove()">‚úï</span>
        </div>
        <p>Great! You now know how to use protect mode.</p>
      `;
      document.body.appendChild(completeNotif);
      const notif = document.getElementById('tutorialNotif2');
      if (notif) notif.remove();
      localStorage.removeItem('tutorialStep');
    })
    .catch(err => console.error(err));
}
<% } %>

// Comment functionality
const commentToggle = document.getElementById('commentToggle');
const commentModal = document.getElementById('commentModal');
const commentClose = document.getElementById('commentClose');
const commentInput = document.getElementById('commentInput');
const submitComment = document.getElementById('submitComment');
const commentList = document.getElementById('commentList');

let hasUnsaved = false;

commentInput.addEventListener('input', () => {
  hasUnsaved = commentInput.value.trim() !== '';
});

async function loadComments() {
  try {
    const res = await fetch(`/comments/${videoId}`);
    if (res.ok) {
      const comments = await res.json();
      commentList.innerHTML = comments.map(c => `
        <div>
          <b>${c.display_name}</b>: ${c.content}
          <span style="font-size:11px; color:var(--muted);">${new Date(c.created_at).toLocaleString()}</span>
        </div>
      `).join('');
    } else {
      commentList.innerHTML = '<p>Error loading comments.</p>';
    }
  } catch (err) {
    console.error(err);
  }
}

commentToggle.addEventListener('click', () => {
  commentModal.classList.add('show');
  loadComments();
});

commentClose.addEventListener('click', () => {
  if (hasUnsaved && !confirm('Are you sure? Exiting will delete your unsaved comment?')) {
    return;
  }
  commentModal.classList.remove('show');
  commentInput.value = '';
  hasUnsaved = false;
});

submitComment.addEventListener('click', async () => {
  const content = commentInput.value.trim();
  if (!content) return;

  try {
    const res = await fetch(`/comments/${videoId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content })
    });

    if (res.ok) {
      commentInput.value = '';
      hasUnsaved = false;
      loadComments();
    } else if (res.status === 401) {
      alert('Please login to comment');
      location.href = '/login';
    } else {
      alert('Error posting comment');
    }
  } catch (err) {
    console.error(err);
  }
});

</script>

</body>
</html>